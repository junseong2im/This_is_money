name: Deploy to EC2

on:
  push:
    branches: [main]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/trading-bot

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Python 의존성 테스트
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          cd python_brain
          pip install -r requirements.txt
          python -c "from core.strategies.breakout import BreakoutStrategy; print('OK')"
      
      # Docker 빌드 및 Push
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and Push Trading Brain
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}-brain:latest ./python_brain
          docker push ${{ env.DOCKER_IMAGE }}-brain:latest
      
      - name: Build and Push Executor
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}-executor:latest ./ts_executor
          docker push ${{ env.DOCKER_IMAGE }}-executor:latest
      
      # EC2 배포
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Pull new images
            docker pull ${{ env.DOCKER_IMAGE }}-brain:latest
            docker pull ${{ env.DOCKER_IMAGE }}-executor:latest
            
            # Stop and remove old containers
            docker stop trading-brain ts-executor 2>/dev/null || true
            docker rm trading-brain ts-executor 2>/dev/null || true
            
            # Run new containers
            docker run -d --name ts-executor \
              -p 3001:3001 \
              -e BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }} \
              -e BINANCE_SECRET_KEY=${{ secrets.BINANCE_SECRET_KEY }} \
              -e EXECUTOR_AUTH_TOKEN=${{ secrets.EXECUTOR_AUTH_TOKEN }} \
              ${{ env.DOCKER_IMAGE }}-executor:latest
            
            docker run -d --name trading-brain \
              -e SYMBOL=BTCUSDT \
              -e INTERVAL_SEC=60 \
              -e EXECUTOR_MODE=http \
              -e TS_EXECUTOR_URL=http://localhost:3001 \
              -e TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
              -e TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }} \
              --network host \
              ${{ env.DOCKER_IMAGE }}-brain:latest
            
            echo "✅ Deployment complete!"
